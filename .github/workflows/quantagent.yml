name: QuantAgent

on:
  # 手动触发
  workflow_dispatch:
    inputs:
      mode:
        description: '运行模式'
        required: false
        default: 'stocks-only'
        type: choice
        options:
          - full          # 完整分析（股票+大盘）
          - market-only   # 仅大盘复盘
          - stocks-only   # 仅股票分析

# 并发控制：同一时间只运行一个分析任务
concurrency:
  group: stock-analysis
  cancel-in-progress: false

jobs:
  analyze:
    runs-on: ubuntu-latest
    # 添加超时限制，防止任务卡死
    timeout-minutes: 30
    
    steps:
      - name: set beijing timezone
        uses: szenius/set-timezone@v2.0 # 设置虚拟环境的时区，可更改时区
        with:
          timezoneLinux: "Asia/Shanghai"
      - name: 检出代码
        uses: actions/checkout@v4
        with:
          ref: master  # 明确指定使用master分支
          fetch-depth: 1  # 只拉取最新提交，加快速度
      
      - name: 设置 Python 环境
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: 安装依赖
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: 创建必要目录
        run: |
          mkdir -p data logs reports
      
      - name: 执行股票分析
        env:
          # ==========================================
          # AI 配置
          # ==========================================
          # # Gemini AI（主选）
          # AGENT_API_KEY: ${{ secrets.GH_API_KEY }}
          # AGENT_LLM_PROVIDER: 'openai'
          # AGENT_LLM_MODEL: 'openai/gpt-4.1'
          # AGENT_LLM_TEMPERATURE: 0.0
          # AGENT_LLM_BASE_URL: 'https://models.github.ai/inference'
          # GRAPH_LLM_PROVIDER: 'openai'
          # GRAPH_LLM_MODEL: 'openai/gpt-4.1'
          # GRAPH_LLM_TEMPERATURE: 0.0
          # GRAPH_LLM_BASE_URL: 'https://models.github.ai/inference'
          # GRAPH_API_KEY: ${{ secrets.GH_API_KEY }}
          AGENT_API_KEY: "89652169c1754f468131df6a9affa521.vCmjdXJWImY7OjLH,7d14b4c07a49473785766fa69b6feed1.OXZ2ZlvfKLzO4lla,fab8db5f2bb045ebb1ca18d315b8b222.tRjEGGexVNM4Otv9,62b2f2da2d014b45bbf55c1fb25eb939.fAAQPfBxSng1BX9v"
          AGENT_LLM_PROVIDER: 'openai'
          AGENT_LLM_MODEL: 'glm-z1-air'
          AGENT_LLM_TEMPERATURE: 0.0
          AGENT_LLM_BASE_URL: 'https://open.bigmodel.cn/api/paas/v4'
          GRAPH_LLM_PROVIDER: 'openai'
          GRAPH_LLM_MODEL: 'glm-4.6V-flash'
          GRAPH_LLM_TEMPERATURE: 0.0
          GRAPH_LLM_BASE_URL: 'https://open.bigmodel.cn/api/paas/v4'
          GRAPH_API_KEY: "89652169c1754f468131df6a9affa521.vCmjdXJWImY7OjLH,7d14b4c07a49473785766fa69b6feed1.OXZ2ZlvfKLzO4lla,fab8db5f2bb045ebb1ca18d315b8b222.tRjEGGexVNM4Otv9,62b2f2da2d014b45bbf55c1fb25eb939.fAAQPfBxSng1BX9v"
          
          
        run: |
          python main.py
      
