# -*- coding: utf-8 -*-
"""
===================================
A股自选股智能分析系统 - 主调度程序
===================================

职责：
1. 协调各模块完成股票分析流程
2. 实现低并发的线程池调度
3. 全局异常处理，确保单股失败不影响整体
4. 提供命令行入口

使用方式：
    python main.py              # 正常运行
    python main.py --debug      # 调试模式
    python main.py --dry-run    # 仅获取数据不分析

交易理念（已融入分析）：
- 严进策略：不追高，乖离率 > 5% 不买入
- 趋势交易：只做 MA5>MA10>MA20 多头排列
- 效率优先：关注筹码集中度好的股票
- 买点偏好：缩量回踩 MA5/MA10 支撑
"""
import os
from src.config import setup_env
setup_env()

# 代理配置 - 通过 USE_PROXY 环境变量控制，默认关闭
# GitHub Actions 环境自动跳过代理配置
if os.getenv("GITHUB_ACTIONS") != "true" and os.getenv("USE_PROXY", "false").lower() == "true":
    # 本地开发环境，启用代理（可在 .env 中配置 PROXY_HOST 和 PROXY_PORT）
    proxy_host = os.getenv("PROXY_HOST", "127.0.0.1")
    proxy_port = os.getenv("PROXY_PORT", "10809")
    proxy_url = f"http://{proxy_host}:{proxy_port}"
    os.environ["http_proxy"] = proxy_url
    os.environ["https_proxy"] = proxy_url

import argparse
import logging
import sys
import time
import uuid
import httpx
from datetime import datetime, timezone, timedelta
from logging.handlers import RotatingFileHandler
from pathlib import Path
from typing import List, Optional

from src.config import get_config, Config
from src.notification import NotificationService
from src.core.pipeline import StockAnalysisPipeline
from src.core.market_review import run_market_review
from src.search_service import SearchService
from src.analyzer import GeminiAnalyzer

# 配置日志格式
LOG_FORMAT = '%(asctime)s | %(levelname)-8s | %(name)-20s | %(message)s'
LOG_DATE_FORMAT = '%Y-%m-%d %H:%M:%S'


def setup_logging(debug: bool = False, log_dir: str = "./logs") -> None:
    """
    配置日志系统（同时输出到控制台和文件）
    
    Args:
        debug: 是否启用调试模式
        log_dir: 日志文件目录
    """
    level = logging.DEBUG if debug else logging.INFO
    
    # 创建日志目录
    log_path = Path(log_dir)
    log_path.mkdir(parents=True, exist_ok=True)
    
    # 日志文件路径（按日期分文件）
    today_str = datetime.now().strftime('%Y%m%d')
    log_file = log_path / f"stock_analysis_{today_str}.log"
    debug_log_file = log_path / f"stock_analysis_debug_{today_str}.log"
    
    # 创建根 logger
    root_logger = logging.getLogger()
    root_logger.setLevel(logging.DEBUG)  # 根 logger 设为 DEBUG，由 handler 控制输出级别
    
    # Handler 1: 控制台输出
    console_handler = logging.StreamHandler(sys.stdout)
    console_handler.setLevel(level)
    console_handler.setFormatter(logging.Formatter(LOG_FORMAT, LOG_DATE_FORMAT))
    root_logger.addHandler(console_handler)
    
    # Handler 2: 常规日志文件（INFO 级别，10MB 轮转）
    file_handler = RotatingFileHandler(
        log_file,
        maxBytes=10 * 1024 * 1024,  # 10MB
        backupCount=5,
        encoding='utf-8'
    )
    file_handler.setLevel(logging.INFO)
    file_handler.setFormatter(logging.Formatter(LOG_FORMAT, LOG_DATE_FORMAT))
    root_logger.addHandler(file_handler)
    
    # Handler 3: 调试日志文件（DEBUG 级别，包含所有详细信息）
    debug_handler = RotatingFileHandler(
        debug_log_file,
        maxBytes=50 * 1024 * 1024,  # 50MB
        backupCount=3,
        encoding='utf-8'
    )
    debug_handler.setLevel(logging.DEBUG)
    debug_handler.setFormatter(logging.Formatter(LOG_FORMAT, LOG_DATE_FORMAT))
    root_logger.addHandler(debug_handler)
    
    # 降低第三方库的日志级别
    logging.getLogger('urllib3').setLevel(logging.WARNING)
    logging.getLogger('sqlalchemy').setLevel(logging.WARNING)
    logging.getLogger('google').setLevel(logging.WARNING)
    logging.getLogger('httpx').setLevel(logging.WARNING)
    
    logging.info(f"日志系统初始化完成，日志目录: {log_path.absolute()}")
    logging.info(f"常规日志: {log_file}")
    logging.info(f"调试日志: {debug_log_file}")


logger = logging.getLogger(__name__)


def parse_arguments() -> argparse.Namespace:
    """解析命令行参数"""
    parser = argparse.ArgumentParser(
        description='A股自选股智能分析系统',
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog='''
示例:
  python main.py                    # 正常运行
  python main.py --debug            # 调试模式
  python main.py --dry-run          # 仅获取数据，不进行 AI 分析
  python main.py --stocks 600519,000001  # 指定分析特定股票
  python main.py --no-notify        # 不发送推送通知
  python main.py --single-notify    # 启用单股推送模式（每分析完一只立即推送）
  python main.py --schedule         # 启用定时任务模式
  python main.py --market-review    # 仅运行大盘复盘
        '''
    )
    
    parser.add_argument(
        '--debug',
        action='store_true',
        help='启用调试模式，输出详细日志'
    )
    
    parser.add_argument(
        '--dry-run',
        action='store_true',
        help='仅获取数据，不进行 AI 分析'
    )
    
    parser.add_argument(
        '--stocks',
        type=str,
        help='指定要分析的股票代码，逗号分隔（覆盖配置文件）'
    )
    
    parser.add_argument(
        '--no-notify',
        action='store_true',
        help='不发送推送通知'
    )
    
    parser.add_argument(
        '--single-notify',
        action='store_true',
        help='启用单股推送模式：每分析完一只股票立即推送，而不是汇总推送'
    )
    
    parser.add_argument(
        '--workers',
        type=int,
        default=None,
        help='并发线程数（默认使用配置值）'
    )
    
    parser.add_argument(
        '--schedule',
        action='store_true',
        help='启用定时任务模式，每日定时执行'
    )
    
    parser.add_argument(
        '--market-review',
        action='store_true',
        help='仅运行大盘复盘分析'
    )
    
    parser.add_argument(
        '--no-market-review',
        action='store_true',
        help='跳过大盘复盘分析'
    )
    
    parser.add_argument(
        '--webui',
        action='store_true',
        help='启动本地配置 WebUI'
    )
    
    parser.add_argument(
        '--webui-only',
        action='store_true',
        help='仅启动 WebUI 服务，不自动执行分析（通过 /analysis API 手动触发）'
    )

    parser.add_argument(
        '--no-context-snapshot',
        action='store_true',
        help='不保存分析上下文快照'
    )
    
    return parser.parse_args()


def run_full_analysis(
    config: Config,
    args: argparse.Namespace,
    stock_codes: Optional[List[str]] = None
):
    """
    执行完整的分析流程（个股 + 大盘复盘）
    
    这是定时任务调用的主函数
    """
    try:

        # full_content = '# 📈 大盘复盘\n\n## 📊 2026-02-05 大盘复盘\n\n### 一、市场总结\n今日A股市场全面下跌，各大指数跌幅均超过1%，市场呈现普跌格局。科创50指数跌幅最大，达1.71%，显示科技板块承压明显，但具体成交额和个股涨跌数据缺失。\n\n### 二、指数点评\n上证指数下跌1.10%，报收4057.11点；深证成指下跌1.59%，报收13931.82点；创业板指下跌1.61%，报收3258.31点。科创50表现最弱，下跌1.71%，报收1428.68点，表明科技创新板块调整压力较大。上证50和沪深300分别下跌1.20%和1.10%，大盘蓝筹股同样承压。\n\n### 三、资金动向\n由于成交额数据显示为0，无法准确判断资金流向。但从普遍下跌的市场表现来看，市场可能面临资金流出或观望情绪浓厚的情况，投资者参与意愿不强。\n\n### 四、热点解读\n由于缺乏具体板块数据，无法分析领涨领跌板块。从市场新闻内容来看，投资者关注点集中在市场复盘方法和历史走势分析上，可能反映了市场对当前走势的担忧和对历史经验的借鉴需求，尤其是对政策底和市场底的探讨。\n\n### 五、后市展望\n从历史数据和市场分析方法来看，当前市场可能处于调整阶段。投资者需关注政策面变化和市场情绪修复情况。历史经验表明，政策底和市场底往往不同步，投资者应保持谨慎，等待更明确的企稳信号，不宜盲目抄底。\n\n### 六、风险提示\n1. 市场普遍下跌，短期调整压力较大；\n2. 缺乏明确的领涨板块，市场热点散乱；\n3. 投资者情绪可能偏悲观，需防范恐慌性抛售；\n4. 关注政策面变化，政策支持可能是市场企稳的关键因素。\n\n---\n\n# 🚀 个股决策仪表盘\n\n# 🎯 2026-02-05 决策仪表盘\n\n> 共分析 **20** 只股票 | 🟢买入:3 🟡观望:7 🔴卖出:10\n\n## 📊 分析结果摘要\n\n🟢 **五芳斋(603237)**: 买入 | 评分 75 | 看多\n🟢 **冀东装备(000856)**: 买入 | 评分 68 | 看多\n🟢 **百达精工(603331)**: 买入 | 评分 65 | 看多\n⚪ **招商银行(600036)**: 观望 | 评分 52 | 震荡\n⚪ **中亚股份(300512)**: 观望 | 评分 45 | 震荡\n⚪ **XD光大银(601818)**: 观望 | 评分 45 | 震荡\n⚪ **中宠股份(002891)**: 观望 | 评分 45 | 震荡\n⚪ **铁科轨道(688569)**: 观望 | 评分 45 | 震荡\n⚪ **富岭股份(001356)**: 观望 | 评分 35 | 看空\n⚪ **宇瞳光学(300790)**: 观望 | 评分 35 | 看空\n⚪ **金达威(002626)**: 观望 | 评分 35 | 看空\n⚪ **中鼎股份(000887)**: 观望 | 评分 35 | 看空\n🔴 **豪威集团(603501)**: 卖出 | 评分 35 | 看空\n🔴 **盾安环境(002011)**: 卖出 | 评分 35 | 看空\n⚪ **京投发展(600683)**: 观望 | 评分 30 | 看空\n🔴 **精研科技(300709)**: 卖出 | 评分 30 | 看空\n🟡 **向日葵(300111)**: 卖出/观望 | 评分 25 | 看空\n⚪ **博威合金(601137)**: 观望 | 评分 25 | 看空\n🟡 **华夏幸福(600340)**: 卖出/观望 | 评分 25 | 看空\n🔴 **中马传动(603767)**: 卖出 | 评分 25 | 看空\n\n---\n\n## 🟢 五芳斋 (603237)\n\n### 📰 重要信息速览\n\n**💭 舆情情绪**: 市场情绪中性偏多\n**📊 业绩预期**: 机构预测三年复合增速达34%，成长性良好\n\n**🚨 风险警报**:\n- 风险点1：业绩增长不及预期\n- 风险点2：原材料价格波动风险\n\n**✨ 利好催化**:\n- 利好1：行业龙头地位稳固\n- 利好2：机构看好长期发展\n\n**📢 最新动态**: 【最新消息】机构给予买入评级，目标价47元\n\n### 📌 核心结论\n\n**🟢 买入** | 看多\n\n> **一句话决策**: 可适量买入，等待突破\n\n⏰ **时效性**: 本周内\n\n| 持仓情况 | 操作建议 |\n|---------|---------|\n| 🆕 **空仓者** | 可分批建仓，关注MA5附近支撑 |\n| 💼 **持仓者** | 继续持有，设好止损位 |\n\n### 📊 数据透视\n\n**均线排列**: MA5>MA10>MA20，多头排列 | 多头排列: ✅ 是 | 趋势强度: 75/100\n\n| 价格指标 | 数值 |\n|---------|------|\n| 当前价 | 17.64 |\n| MA5 | 17.36 |\n| MA10 | 17.31 |\n| MA20 | 17.21 |\n| 乖离率(MA5) | 1.61% ✅安全 |\n| 支撑位 | 17.21 |\n| 压力位 | 18.0 |\n\n**量能**: 量比 1.99 (放量) | 换手率 0.55%\n💡 *温和放量，显示资金入场*\n\n**筹码**: 获利比例 59.6 | 平均成本 17.4 | 集中度 7.39 ✅健康\n\n### 🎯 作战计划\n\n**📍 狙击点位**\n\n| 点位类型 | 价格 |\n|---------|------|\n| 🎯 理想买入点 | 理想买入点：17.36元（在MA5附近） |\n| 🔵 次优买入点 | 次优买入点：17.31元（在MA10附近） |\n| 🛑 止损位 | 止损位：17.21元（跌破MA20） |\n| 🎊 目标位 | 目标位：19.00元（前期高点附近） |\n\n**💰 仓位建议**: 建议仓位：3成\n- 建仓策略: 分批建仓，先建1成仓，回调至MA5附近再加仓\n- 风控策略: 跌破MA20立即止损，不抱侥幸心理\n\n**✅ 检查清单**\n\n- ✅ 检查项1：多头排列\n- ✅ 检查项2：乖离率<5%\n- ✅ 检查项3：量能配合\n- ✅ 检查项4：无重大利空\n- ✅ 检查项5：筹码健康\n\n---\n\n## 🟢 冀东装备 (000856)\n\n### 📰 重要信息速览\n\n**💭 舆情情绪**: 技术面良好，但存在监管风险，市场情绪谨慎偏多\n**📊 业绩预期**: 缺乏最新业绩预告，历史数据显示2023年半年度业绩同向上升，2022年度业绩同向下降\n\n**🚨 风险警报**:\n- 风险点1：未按规定披露关联交易被责令改正\n- 风险点2：机构净卖出较多，超5000万元\n- 风险点3：与人形机器人概念无关，谨防概念炒作回落\n\n**✨ 利好催化**:\n- 利好1：技术面多头排列，乖离率处于安全区间\n- 利好2：筹码结构健康，集中度高\n- 利好3：2023年半年度业绩预告同向上升\n\n**📢 最新动态**: 【最新消息】2026-02-04涨停，涨幅9.96%；2025-12-11因未按规定披露关联交易被责令改正\n\n### 📌 核心结论\n\n**🟢 买入** | 看多\n\n> **一句话决策**: 技术面良好，谨慎小仓买入\n\n⏰ **时效性**: 本周内\n\n| 持仓情况 | 操作建议 |\n|---------|---------|\n| 🆕 **空仓者** | 小仓试探性买入，严格止损 |\n| 💼 **持仓者** | 可继续持有，密切关注风险变化 |\n\n### 📊 数据透视\n\n**均线排列**: MA5>MA10>MA20，多头排列 | 多头排列: ✅ 是 | 趋势强度: 75/100\n\n| 价格指标 | 数值 |\n|---------|------|\n| 当前价 | 11.25 |\n| MA5 | 11.04 |\n| MA10 | 10.8 |\n| MA20 | 10.64 |\n| 乖离率(MA5) | 1.9% ✅安全 |\n| 支撑位 | 10.64 |\n| 压力位 | 12.0 |\n\n**量能**: 量比 2.6 (放量) | 换手率 5.01%\n💡 *放量下跌，可能是洗盘或调整*\n\n**筹码**: 获利比例 62.7 | 平均成本 11.01 | 集中度 8.07 ✅健康\n\n### 🎯 作战计划\n\n**📍 狙击点位**\n\n| 点位类型 | 价格 |\n|---------|------|\n| 🎯 理想买入点 | 理想买入点：11.04元（在MA5附近） |\n| 🔵 次优买入点 | 次优买入点：10.8元（在MA10附近） |\n| 🛑 止损位 | 止损位：10.64元（跌破MA20） |\n| 🎊 目标位 | 目标位：12.0元（前期高点附近） |\n\n**💰 仓位建议**: 建议仓位：2-3成\n- 建仓策略: 分批建仓，先小仓试探，回调MA5附近加仓\n- 风控策略: 跌破MA20立即止损，密切关注监管风险进展\n\n**✅ 检查清单**\n\n- ✅ 检查项1：多头排列\n- ✅ 检查项2：乖离率<5%\n- ⚠️ 检查项3：量能配合\n- ⚠️ 检查项4：无重大利空\n- ✅ 检查项5：筹码健康\n\n---\n\n## 🟢 百达精工 (603331)\n\n### 📰 重要信息速览\n\n**💭 舆情情绪**: 技术面良好但减持利空压制，情绪谨慎偏多\n**📊 业绩预期**: 业绩预告不完整，无法准确判断，需持续关注\n\n**🚨 风险警报**:\n- 风险点1：股东减持不超2%股份\n- 风险点2：换手率较高，短期波动风险\n\n**✨ 利好催化**:\n- 利好1：压缩机行业政策支持，整体向上发展\n- 利好2：均线多头排列，技术面良好\n\n**📢 最新动态**: 【最新消息】股东拟减持不超2%公司股份\n\n### 📌 核心结论\n\n**🟢 买入** | 看多\n\n> **一句话决策**: 谨慎买入，控制仓位\n\n⏰ **时效性**: 本周内\n\n| 持仓情况 | 操作建议 |\n|---------|---------|\n| 🆕 **空仓者** | 空仓者建议：小仓位买入，严格设置止损 |\n| 💼 **持仓者** | 持仓者建议：继续持有，关注减持进展 |\n\n### 📊 数据透视\n\n**均线排列**: 多头排列，MA5>MA10>MA20 | 多头排列: ✅ 是 | 趋势强度: 75/100\n\n| 价格指标 | 数值 |\n|---------|------|\n| 当前价 | 16.31 |\n| MA5 | 16.21 |\n| MA10 | 15.67 |\n| MA20 | 14.8 |\n| 乖离率(MA5) | 0.62% ✅安全 |\n| 支撑位 | 15.67 |\n| 压力位 | 17.5 |\n\n**量能**: 量比 1.81 (放量) | 换手率 10.0%\n💡 *温和放量，但换手率较高，需警惕短期波动*\n\n**筹码**: 获利比例 64.8 | 平均成本 15.99 | 集中度 10.96 ✅健康\n\n### 🎯 作战计划\n\n**📍 狙击点位**\n\n| 点位类型 | 价格 |\n|---------|------|\n| 🎯 理想买入点 | 理想买入点：16.21元（在MA5附近） |\n| 🔵 次优买入点 | 次优买入点：15.67元（在MA10附近） |\n| 🛑 止损位 | 止损位：14.80元（跌破MA20） |\n| 🎊 目标位 | 目标位：17.50元（前期高点） |\n\n**💰 仓位建议**: 建议仓位：3成\n- 建仓策略: 分批建仓，先小仓位试探，确认无减持影响后再加仓\n- 风控策略: 严格止损，跌破MA20立即止损，控制单笔损失不超过2%\n\n**✅ 检查清单**\n\n- ✅ 检查项1：多头排列\n- ✅ 检查项2：乖离率<5%\n- ⚠️ 检查项3：量能配合\n- ❌ 检查项4：无重大利空\n- ✅ 检查项5：筹码健康\n\n---\n\n## ⚪ 招商银行 (600036)\n\n### 📰 重要信息速览\n\n**💭 舆情情绪**: 中性偏谨慎，监管风险与业绩疲软压制股价\n**📊 业绩预期**: 净利润同比增长1.21%，保持正增长但增速缓慢，业绩增长乏力\n\n**🚨 风险警报**:\n- 风险点1：年内收到7张罚单，罚款近4000万元\n- 风险点2：内控管理问题频发\n- 风险点3：业绩增速持续放缓\n\n**✨ 利好催化**:\n- 利好1：机构给予买入评级，目标价44.9元\n- 利好2：净利润保持正增长\n\n**📢 最新动态**: 【最新消息】招商银行2025年业绩微增，净利润同比增长1.21%；同时面临监管处罚风险\n\n### 📌 核心结论\n\n**⚪ 观望** | 震荡\n\n> **一句话决策**: 观望为主，等待趋势明朗\n\n⏰ **时效性**: 不急\n\n| 持仓情况 | 操作建议 |\n|---------|---------|\n| 🆕 **空仓者** | 空仓者建议：暂时观望，等待均线形成多头排列且放量 |\n| 💼 **持仓者** | 持仓者建议：可继续持有，设置止损位在MA20下方38.00元 |\n\n### 📊 数据透视\n\n**均线排列**: 均线缠绕状态，MA5=MA20，MA10低于两者 | 多头排列: ❌ 否 | 趋势强度: 50/100\n\n| 价格指标 | 数值 |\n|---------|------|\n| 当前价 | 39.19 |\n| MA5 | 38.72 |\n| MA10 | 38.36 |\n| MA20 | 38.72 |\n| 乖离率(MA5) | 1.21% ✅安全 |\n| 支撑位 | 38.72 |\n| 压力位 | 40.2 |\n\n**量能**: 量比 0.8 (缩量) | 换手率 0.15%\n💡 *缩量表示市场参与度不高，缺乏方向性动能*\n\n**筹码**: 获利比例 18.4 | 平均成本 42.06 | 集中度 9.52 ⚠️一般\n\n### 🎯 作战计划\n\n**📍 狙击点位**\n\n| 点位类型 | 价格 |\n|---------|------|\n| 🎯 理想买入点 | 理想买入点：38.70元（在MA5附近） |\n| 🔵 次优买入点 | 次优买入点：38.30元（在MA10附近） |\n| 🛑 止损位 | 止损位：38.00元（跌破MA20约1.8%） |\n| 🎊 目标位 | 目标位：40.20元（前期高点） |\n\n**💰 仓位建议**: 建议仓位：2成\n- 建仓策略: 分批建仓，先轻仓试探，等待趋势明朗后再加仓\n- 风控策略: 严格止损，跌破MA20立即止损；关注量能变化，放量突破可适当加仓\n\n**✅ 检查清单**\n\n- ❌ 检查项1：多头排列\n- ✅ 检查项2：乖离率<5%\n- ⚠️ 检查项3：量能配合\n- ⚠️ 检查项4：无重大利空\n- ⚠️ 检查项5：筹码健康\n\n---\n\n## ⚪ 中亚股份 (300512)\n\n### 📰 重要信息速览\n\n**💭 舆情情绪**: 技术面良好，但减持压力和业绩预期下滑带来不确定性\n**📊 业绩预期**: 2025年前三季度业绩良好，但2024年度业绩预期下滑，存在不确定性\n\n**🚨 风险警报**:\n- 风险点1：高管拟减持公司股份\n- 风险点2：2024年业绩预期下滑46.43%-26.96%\n\n**✨ 利好催化**:\n- 利好1：2025年前三季度业绩同比增长21.03%\n- 利好2：智能包装机械行业龙头\n\n**📢 最新动态**: 【最新消息】董事、高级管理人员拟减持公司股份；2025年前三季归母净利润同比增长21.03%\n\n### 📌 核心结论\n\n**⚪ 观望** | 震荡\n\n> **一句话决策**: 技术面良好但有利空，建议观望\n\n⏰ **时效性**: 本周内\n\n| 持仓情况 | 操作建议 |\n|---------|---------|\n| 🆕 **空仓者** | 空仓者建议：暂不介入，等待减持风险释放 |\n| 💼 **持仓者** | 持仓者建议：可继续持有，但需密切关注减持进展 |\n\n### 📊 数据透视\n\n**均线排列**: MA5>MA10>MA20，多头排列 | 多头排列: ✅ 是 | 趋势强度: 70/100\n\n| 价格指标 | 数值 |\n|---------|------|\n| 当前价 | 10.16 |\n| MA5 | 10.22 |\n| MA10 | 10.15 |\n| MA20 | 9.88 |\n| 乖离率(MA5) | -0.59% ✅安全 |\n| 支撑位 | 10.15 |\n| 压力位 | 10.26 |\n\n**量能**: 量比 0.98 (缩量) | 换手率 0.76%\n💡 *缩量回调表示抛压减轻，但需警惕量能不足*\n\n**筹码**: 获利比例 63.5 | 平均成本 10.04 | 集中度 7.14 ✅健康\n\n### 🎯 作战计划\n\n**📍 狙击点位**\n\n| 点位类型 | 价格 |\n|---------|------|\n| 🎯 理想买入点 | 理想买入点：10.15元（在MA10附近） |\n| 🔵 次优买入点 | 次优买入点：9.88元（在MA20附近） |\n| 🛑 止损位 | 止损位：9.80元（跌破MA20） |\n| 🎊 目标位 | 目标位：10.80元（前高附近） |\n\n**💰 仓位建议**: 建议仓位：3成\n- 建仓策略: 减持风险释放后可分批建仓\n- 风控策略: 严格设置止损，密切关注减持进展\n\n**✅ 检查清单**\n\n- ✅ 检查项1：多头排列\n- ✅ 检查项2：乖离率<5%\n- ⚠️ 检查项3：量能配合\n- ❌ 检查项4：无重大利空\n- ✅ 检查项5：筹码健康\n\n---\n\n## ⚪ XD光大银 (601818)\n\n### 📰 重要信息速览\n\n**💭 舆情情绪**: 市场情绪中性，缺乏明显催化剂\n**📊 业绩预期**: 业绩预期稳定，无明显变化\n\n**🚨 风险警报**:\n- 风险点1：筹码套牢盘极重(>70%)\n- 风险点2：均线未形成多头排列\n\n**✨ 利好催化**:\n- 利好1：乖离率处于安全区间\n- 利好2：筹码集中度较高\n\n**📢 最新动态**: 【最新消息】无明显重大新闻，银行股整体处于震荡整理阶段\n\n### 📌 核心结论\n\n**⚪ 观望** | 震荡\n\n> **一句话决策**: 均线未多头排列，建议观望\n\n⏰ **时效性**: 不急\n\n| 持仓情况 | 操作建议 |\n|---------|---------|\n| 🆕 **空仓者** | 空仓者建议：等待多头排列形成后再考虑介入 |\n| 💼 **持仓者** | 持仓者建议：可继续持有，关注MA20支撑，跌破则止损 |\n\n### 📊 数据透视\n\n**均线排列**: 均线缠绕震荡：MA5=MA10<MA20 | 多头排列: ❌ 否 | 趋势强度: 40/100\n\n| 价格指标 | 数值 |\n|---------|------|\n| 当前价 | 3.31 |\n| MA5 | 3.25 |\n| MA10 | 3.25 |\n| MA20 | 3.28 |\n| 乖离率(MA5) | 1.85% ✅安全 |\n| 支撑位 | 3.28 |\n| 压力位 | 3.35 |\n\n**量能**: 量比 0.93 (缩量) | 换手率 0.26%\n💡 *缩量上涨，缺乏资金关注，上涨持续性存疑*\n\n**筹码**: 获利比例 2.8 | 平均成本 3.52 | 集中度 11.29 🚨警惕\n\n### 🎯 作战计划\n\n**📍 狙击点位**\n\n| 点位类型 | 价格 |\n|---------|------|\n| 🎯 理想买入点 | 理想买入点：3.28元（在MA20附近） |\n| 🔵 次优买入点 | 次优买入点：3.35元（突破阻力位后回踩） |\n| 🛑 止损位 | 止损位：3.25元（跌破MA5和MA10） |\n| 🎊 目标位 | 目标位：3.40元（前期高点） |\n\n**💰 仓位建议**: 建议仓位：1成（试探性仓位）\n- 建仓策略: 等待多头排列形成后分批建仓\n- 风控策略: 严格控制在MA20下方止损\n\n**✅ 检查清单**\n\n- ❌ 检查项1：多头排列\n- ✅ 检查项2：乖离率<5%\n- ⚠️ 检查项3：量能配合\n- ✅ 检查项4：无重大利空\n- ❌ 检查项5：筹码健康\n\n---\n\n## ⚪ 中宠股份 (002891)\n\n### 📰 重要信息速览\n\n**💭 舆情情绪**: 基本面良好，技术面偏弱，市场情绪谨慎\n**📊 业绩预期**: 业绩表现良好，前三季度和第三季度净利润均实现较大增长\n\n**🚨 风险警报**:\n- 风险点1：均线空头排列，趋势尚未明朗\n- 风险点2：大部分投资者处于套牢状态\n\n**✨ 利好催化**:\n- 利好1：业绩持续增长\n- 利好2：宠物食品龙头，行业前景看好\n\n**📢 最新动态**: 【最新消息】前三季度净利润3.33亿元同比增长18.21%，第三季度净利同比增49.19%\n\n### 📌 核心结论\n\n**⚪ 观望** | 震荡\n\n> **一句话决策**: 均线空头排列，等待趋势明朗\n\n⏰ **时效性**: 不急\n\n| 持仓情况 | 操作建议 |\n|---------|---------|\n| 🆕 **空仓者** | 空仓者建议：暂不介入，等待多头排列形成 |\n| 💼 **持仓者** | 持仓者建议：耐心持有，设置止损位MA20(50.85元) |\n\n### 📊 数据透视\n\n**均线排列**: 均线空头排列：MA5<MA10<MA20 | 多头排列: ❌ 否 | 趋势强度: 35/100\n\n| 价格指标 | 数值 |\n|---------|------|\n| 当前价 | 49.64 |\n| MA5 | 49.14 |\n| MA10 | 49.48 |\n| MA20 | 50.85 |\n| 乖离率(MA5) | 1.02% ✅安全 |\n| 支撑位 | 48.14 |\n| 压力位 | 50.85 |\n\n**量能**: 量比 3.02 (放量) | 换手率 1.25%\n💡 *巨量但涨幅不大，可能是资金调仓*\n\n**筹码**: 获利比例 6.4 | 平均成本 54.62 | 集中度 10.17 ⚠️一般\n\n### 🎯 作战计划\n\n**📍 狙击点位**\n\n| 点位类型 | 价格 |\n|---------|------|\n| 🎯 理想买入点 | 理想买入点：等待MA5>MA10>MA20多头排列形成 |\n| 🔵 次优买入点 | 次优买入点：突破MA20(50.85元)并站稳 |\n| 🛑 止损位 | 止损位：48.14元（今日最低价） |\n| 🎊 目标位 | 目标位：55.00元（前期高点/平均成本附近） |\n\n**💰 仓位建议**: 建议仓位：暂不建仓\n- 建仓策略: 等待多头排列形成后分批建仓\n- 风控策略: 跌破48.14元止损，不追高\n\n**✅ 检查清单**\n\n- ❌ 检查项1：多头排列\n- ✅ 检查项2：乖离率<5%\n- ⚠️ 检查项3：量能配合\n- ✅ 检查项4：无重大利空\n- ⚠️ 检查项5：筹码健康\n\n---\n\n## ⚪ 铁科轨道 (688569)\n\n### 📰 重要信息速览\n\n**💭 舆情情绪**: 技术面空头排列，但基本面良好，投资者情绪谨慎\n**📊 业绩预期**: 业绩预期较好，2022年净利润同比增长40.99%，2023年Q1利润率创上市以来新高\n\n**🚨 风险警报**:\n- 风险点1：存在监管处罚和违规记录\n- 风险点2：研发失败风险\n\n**✨ 利好催化**:\n- 利好1：高铁扣件市场占有率达20.65%\n- 利好2：业绩持续增长\n\n**📢 最新动态**: 【最新消息】公司2022年净利润同比增长40.99%，2023年Q1利润率创上市以来新高\n\n### 📌 核心结论\n\n**⚪ 观望** | 震荡\n\n> **一句话决策**: 空头排列，观望等待趋势明朗\n\n⏰ **时效性**: 不急\n\n| 持仓情况 | 操作建议 |\n|---------|---------|\n| 🆕 **空仓者** | 空仓者建议：暂不买入，等待多头排列形成 |\n| 💼 **持仓者** | 持仓者建议：可继续持有，关注MA20支撑，若放量跌破则止损 |\n\n### 📊 数据透视\n\n**均线排列**: 空头排列：MA5 < MA10 < MA20 | 多头排列: ❌ 否 | 趋势强度: 30/100\n\n| 价格指标 | 数值 |\n|---------|------|\n| 当前价 | 20.92 |\n| MA5 | 21.05 |\n| MA10 | 21.55 |\n| MA20 | 21.82 |\n| 乖离率(MA5) | -0.62% ✅安全 |\n| 支撑位 | 20.5 |\n| 压力位 | 21.82 |\n\n**量能**: 量比 1.41 (温和放量) | 换手率 0.32%\n💡 *量比1.41但成交量较昨日减少，显示抛压有所减轻但买盘不足*\n\n**筹码**: 获利比例 7.1 | 平均成本 21.97 | 集中度 7.79 ✅健康\n\n### 🎯 作战计划\n\n**📍 狙击点位**\n\n| 点位类型 | 价格 |\n|---------|------|\n| 🎯 理想买入点 | 理想买入点：20.5元（前期低点支撑） |\n| 🔵 次优买入点 | 次优买入点：21.82元（突破MA20阻力） |\n| 🛑 止损位 | 止损位：20.5元（跌破前期低点） |\n| 🎊 目标位 | 目标位：23.0元（前期高点） |\n\n**💰 仓位建议**: 建议仓位：3成（轻仓试探）\n- 建仓策略: 等待多头排列形成（MA5>MA10>MA20）后分批建仓\n- 风控策略: 严格控制在20.5元止损，避免追高\n\n**✅ 检查清单**\n\n- ❌ 检查项1：多头排列\n- ✅ 检查项2：乖离率<5%\n- ⚠️ 检查项3：量能配合\n- ❌ 检查项4：无重大利空\n- ✅ 检查项5：筹码健康\n\n---\n\n## ⚪ 富岭股份 (001356)\n\n### 📰 重要信息速览\n\n**💭 舆情情绪**: 市场情绪偏谨慎，技术面空头排列，基本面承压\n**📊 业绩预期**: 业绩预期分析：2025年业绩下滑，主要受全球税收政策变化、印尼投资成本增加及原材料价格波动影响\n\n**🚨 风险警报**:\n- 风险点1：空头排列，趋势向下\n- 风险点2：2025年业绩下滑\n- 风险点3：套牢盘极重(>70%)\n- 风险点4：对海外市场依存度高\n\n**✨ 利好催化**:\n- 利好1：生物降解材料技术领先\n- 利好2：筹码集中度高(90%集中度<15%)\n\n**📢 最新动态**: 【最新消息】公司2025年业绩预告显示利润下滑，主要受全球税收政策变化、印尼投资成本增加及原材料价格波动影响\n\n### 📌 核心结论\n\n**⚪ 观望** | 看空\n\n> **一句话决策**: 空头排列，等待企稳信号\n\n⏰ **时效性**: 本周内\n\n| 持仓情况 | 操作建议 |\n|---------|---------|\n| 🆕 **空仓者** | 空仓者建议：暂不介入，等待多头排列形成 |\n| 💼 **持仓者** | 持仓者建议：轻仓持有，严控止损，反弹减仓 |\n\n### 📊 数据透视\n\n**均线排列**: 空头排列：MA5 < MA10 < MA20 | 多头排列: ❌ 否 | 趋势强度: 30/100\n\n| 价格指标 | 数值 |\n|---------|------|\n| 当前价 | 12.64 |\n| MA5 | 12.56 |\n| MA10 | 12.72 |\n| MA20 | 13.01 |\n| 乖离率(MA5) | 0.64% ✅安全 |\n| 支撑位 | 12.5 |\n| 压力位 | 12.72 |\n\n**量能**: 量比 1.02 (缩量) | 换手率 0.49%\n💡 *缩量回调，市场参与度低*\n\n**筹码**: 获利比例 9.7 | 平均成本 13.3 | 集中度 9.55 🚨警惕\n\n### 🎯 作战计划\n\n**📍 狙击点位**\n\n| 点位类型 | 价格 |\n|---------|------|\n| 🎯 理想买入点 | 理想买入点：暂无（等待多头排列形成） |\n| 🔵 次优买入点 | 次优买入点：暂无（等待多头排列形成） |\n| 🛑 止损位 | 止损位：12.5元（跌破前低） |\n| 🎊 目标位 | 目标位：13.01元（突破MA20） |\n\n**💰 仓位建议**: 建议仓位：1成以下\n- 建仓策略: 暂不建仓，等待多头排列形成\n- 风控策略: 跌破12.5元止损，不盲目抄底\n\n**✅ 检查清单**\n\n- ❌ 检查项1：多头排列\n- ✅ 检查项2：乖离率<5%\n- ⚠️ 检查项3：量能配合\n- ❌ 检查项4：无重大利空\n- ❌ 检查项5：筹码健康\n\n---\n\n## ⚪ 宇瞳光学 (300790)\n\n### 📰 重要信息速览\n\n**💭 舆情情绪**: 业绩向好但公司治理风险令市场担忧\n**📊 业绩预期**: 业绩预期较好，2025年净利预计同比增长30.75%-52.54%，上半年净利同比预增200.74%—237.87%\n\n**🚨 风险警报**:\n- 风险点1：高管减持\n- 风险点2：董事增持计划\'爽约\'\n\n**✨ 利好催化**:\n- 利好1：业绩预增30.75%-52.54%\n- 利好2：光学镜头行业\'隐形冠军\'\n\n**📢 最新动态**: 【最新消息】公司预计2025年净利同比增长30.75%-52.54%，但高管减持和董事增持计划\'爽约\'引发争议\n\n### 📌 核心结论\n\n**⚪ 观望** | 看空\n\n> **一句话决策**: 空头排列，建议观望等待企稳\n\n⏰ **时效性**: 不急\n\n| 持仓情况 | 操作建议 |\n|---------|---------|\n| 🆕 **空仓者** | 空仓者建议：暂不介入，等待多头排列形成 |\n| 💼 **持仓者** | 持仓者建议：若亏损不大可考虑减仓或止损 |\n\n### 📊 数据透视\n\n**均线排列**: 空头排列：MA5 < MA10 < MA20 | 多头排列: ❌ 否 | 趋势强度: 25/100\n\n| 价格指标 | 数值 |\n|---------|------|\n| 当前价 | 26.5 |\n| MA5 | 26.69 |\n| MA10 | 27.98 |\n| MA20 | 29.51 |\n| 乖离率(MA5) | -0.71% ✅安全 |\n| 支撑位 | 25.8 |\n| 压力位 | 27.0 |\n\n**量能**: 量比 0.76 (缩量) | 换手率 0.76%\n💡 *缩量回调，抛压减轻但缺乏买盘*\n\n**筹码**: 获利比例 1.5 | 平均成本 30.23 | 集中度 8.95 🚨警惕\n\n### 🎯 作战计划\n\n**📍 狙击点位**\n\n| 点位类型 | 价格 |\n|---------|------|\n| 🎯 理想买入点 | 理想买入点：25.8元（前低附近） |\n| 🔵 次优买入点 | 次优买入点：24.5元（突破前低后） |\n| 🛑 止损位 | 止损位：25.0元（跌破重要支撑） |\n| 🎊 目标位 | 目标位：29.5元（MA20附近） |\n\n**💰 仓位建议**: 建议仓位：1成\n- 建仓策略: 等待多头排列形成后分批建仓\n- 风控策略: 严格设置止损，控制单笔亏损不超过总资金的2%\n\n**✅ 检查清单**\n\n- ❌ 检查项1：多头排列\n- ✅ 检查项2：乖离率<5%\n- ⚠️ 检查项3：量能配合\n- ❌ 检查项4：无重大利空\n- ❌ 检查项5：筹码健康\n\n---\n\n## ⚪ 金达威 (002626)\n\n### 📰 重要信息速览\n\n**💭 舆情情绪**: 舆情情绪：安全事故与减持压制股价，业绩增长提供支撑\n**📊 业绩预期**: 业绩预期良好，2025年上半年净利润2.47亿元，同比+90.1%\n\n**🚨 风险警报**:\n- 风险点1：子公司发生安全事故，影响生产经营\n- 风险点2：控股股东减持616.29万股\n- 风险点3：存在安全生产违规记录\n\n**✨ 利好催化**:\n- 利好1：维生素公司处于满负荷生产状态\n- 利好2：天风证券给予买入评级，目标价25.7元\n- 利好3：2025年半年度净利润同比增长90.1%\n\n**📢 最新动态**: 【最新消息】子公司发生安全事故，控股股东减持，安全生产违规被处罚\n\n### 📌 核心结论\n\n**⚪ 观望** | 看空\n\n> **一句话决策**: 趋势向下，利空缠身，建议观望\n\n⏰ **时效性**: 本周内\n\n| 持仓情况 | 操作建议 |\n|---------|---------|\n| 🆕 **空仓者** | 空仓者建议：暂不介入，等待均线多头排列 |\n| 💼 **持仓者** | 持仓者建议：考虑减仓或止损，避免更大损失 |\n\n### 📊 数据透视\n\n**均线排列**: 空头排列：MA5 < MA10 < MA20 | 多头排列: ❌ 否 | 趋势强度: 30/100\n\n| 价格指标 | 数值 |\n|---------|------|\n| 当前价 | 19.13 |\n| MA5 | 18.81 |\n| MA10 | 19.3 |\n| MA20 | 19.63 |\n| 乖离率(MA5) | 1.7% ✅安全 |\n| 支撑位 | 18.5 |\n| 压力位 | 19.6 |\n\n**量能**: 量比 2.15 (放量) | 换手率 0.66%\n💡 *放量上涨但未突破压力位，可能为反弹而非反转*\n\n**筹码**: 获利比例 26.1 | 平均成本 19.88 | 集中度 6.81 🚨警惕\n\n### 🎯 作战计划\n\n**📍 狙击点位**\n\n| 点位类型 | 价格 |\n|---------|------|\n| 🎯 理想买入点 | 理想买入点：暂不建议（等待多头排列） |\n| 🔵 次优买入点 | 次优买入点：暂不建议 |\n| 🛑 止损位 | 止损位：18.5元（跌破近期低点） |\n| 🎊 目标位 | 目标位：20.5元（突破MA20压力） |\n\n**💰 仓位建议**: 建议仓位：0-1成\n- 建仓策略: 暂不建议建仓，等待均线多头排列形成\n- 风控策略: 如持有建议控制仓位，设置严格止损\n\n**✅ 检查清单**\n\n- ❌ 检查项1：多头排列\n- ✅ 检查项2：乖离率<5%\n- ✅ 检查项3：量能配合\n- ❌ 检查项4：无重大利空\n- ⚠️ 检查项5：筹码健康\n\n---\n\n## ⚪ 中鼎股份 (000887)\n\n### 📰 重要信息速览\n\n**💭 舆情情绪**: 技术面弱势，但基本面仍有支撑\n**📊 业绩预期**: 业绩预期较好，2023年净利预计11.2-12.2亿元，同比增长16.15%\n\n**🚨 风险警报**:\n- 风险点1：机构资金大幅卖出\n- 风险点2：空头排列趋势未改\n\n**✨ 利好催化**:\n- 利好1：多家券商给予买入评级，目标价22-28元\n- 利好2：预计2023年净利润同比增长16.15%\n\n**📢 最新动态**: 【最新消息】中鼎股份跌停，三机构合计卖出1.57亿元\n\n### 📌 核心结论\n\n**⚪ 观望** | 看空\n\n> **一句话决策**: 空头排列，观望等待企稳\n\n⏰ **时效性**: 不急\n\n| 持仓情况 | 操作建议 |\n|---------|---------|\n| 🆕 **空仓者** | 空仓者建议：暂不介入，等待多头排列形成 |\n| 💼 **持仓者** | 持仓者建议：如被套可考虑反弹减仓，等待企稳信号 |\n\n### 📊 数据透视\n\n**均线排列**: 空头排列：MA5 < MA10 < MA20 | 多头排列: ❌ 否 | 趋势强度: 25/100\n\n| 价格指标 | 数值 |\n|---------|------|\n| 当前价 | 20.56 |\n| MA5 | 20.72 |\n| MA10 | 21.37 |\n| MA20 | 22.28 |\n| 乖离率(MA5) | -0.77% ✅安全 |\n| 支撑位 | 20.0 |\n| 压力位 | 21.37 |\n\n**量能**: 量比 1.29 (缩量) | 换手率 0.82%\n💡 *缩量下跌表明抛压减轻但买盘不足*\n\n**筹码**: 获利比例 3.7 | 平均成本 22.73 | 集中度 9.45 🚨警惕\n\n### 🎯 作战计划\n\n**📍 狙击点位**\n\n| 点位类型 | 价格 |\n|---------|------|\n| 🎯 理想买入点 | 理想买入点：20.00元（整数关口支撑） |\n| 🔵 次优买入点 | 次优买入点：19.50元（前低附近） |\n| 🛑 止损位 | 止损位：19.80元（跌破前低） |\n| 🎊 目标位 | 目标位：22.28元（MA20均线） |\n\n**💰 仓位建议**: 建议仓位：1-2成（轻仓试探）\n- 建仓策略: 等待多头排列形成后，分批建仓\n- 风控策略: 严格止损，跌破关键支撑位立即离场\n\n**✅ 检查清单**\n\n- ❌ 检查项1：多头排列\n- ✅ 检查项2：乖离率<5%\n- ❌ 检查项3：量能配合\n- ⚠️ 检查项4：无重大利空\n- ❌ 检查项5：筹码健康\n\n---\n\n## 🟠 豪威集团 (603501)\n\n### 📰 重要信息速览\n\n**💭 舆情情绪**: 大股东减持引发市场担忧，虽有业绩增长但机构分歧加大\n**📊 业绩预期**: 业绩波动较大，2025年半年度净利润增加13.49%到15.97%，但预告显示同比下滑\n\n**🚨 风险警报**:\n- 风险点1：实际控制人虞仁荣减持35亿元以上\n- 风险点2：Norges Bank减持7.65万股\n- 风险点3：业绩预告显示同比下滑\n\n**✨ 利好催化**:\n- 利好1：上半年净利润同比增长48.34%\n- 利好2：机构看好长期增长空间，上调目标价\n- 利好3：全球CIS三巨头之一，国产替代风势不减\n\n**📢 最新动态**: 【最新消息】上半年净利润20.28亿元，同比增长48.34%；实际控制人虞仁荣减持35亿元以上\n\n### 📌 核心结论\n\n**🟠 减仓** | 看空\n\n> **一句话决策**: 空头排列，套牢盘重，建议减仓或观望\n\n⏰ **时效性**: 本周内\n\n| 持仓情况 | 操作建议 |\n|---------|---------|\n| 🆕 **空仓者** | 空仓者建议：继续观望，等待多头排列形成 |\n| 💼 **持仓者** | 持仓者建议：减仓或止损，规避大股东减持风险 |\n\n### 📊 数据透视\n\n**均线排列**: 空头排列：MA5(118.44) < MA10(122.2) < MA20(125.98) | 多头排列: ❌ 否 | 趋势强度: 25/100\n\n| 价格指标 | 数值 |\n|---------|------|\n| 当前价 | 117.34 |\n| MA5 | 118.44 |\n| MA10 | 122.2 |\n| MA20 | 125.98 |\n| 乖离率(MA5) | -0.93% ✅安全 |\n| 支撑位 | 115.0 |\n| 压力位 | 120.0 |\n\n**量能**: 量比 0.86 (缩量) | 换手率 0.41%\n💡 *缩量横盘，市场参与度低，观望情绪浓厚*\n\n**筹码**: 获利比例 2.9 | 平均成本 128.79 | 集中度 10.9 🚨警惕\n\n### 🎯 作战计划\n\n**📍 狙击点位**\n\n| 点位类型 | 价格 |\n|---------|------|\n| 🎯 理想买入点 | 理想买入点：暂无（需等待多头排列形成） |\n| 🔵 次优买入点 | 次优买入点：暂无（需等待多头排列形成） |\n| 🛑 止损位 | 止损位：115.00元（跌破近期低点） |\n| 🎊 目标位 | 目标位：暂无（空头趋势不设目标位） |\n\n**💰 仓位建议**: 建议仓位：0-1成\n- 建仓策略: 暂不建议入场，等待均线多头排列形成\n- 风控策略: 严格控制仓位，若持仓应设置止损位115元\n\n**✅ 检查清单**\n\n- ❌ 检查项1：多头排列\n- ✅ 检查项2：乖离率<5%\n- ⚠️ 检查项3：量能配合\n- ❌ 检查项4：无重大利空\n- ❌ 检查项5：筹码健康\n\n---\n\n## 🟠 盾安环境 (002011)\n\n### 📰 重要信息速览\n\n**💭 舆情情绪**: 业绩向好但风险因素较多，市场情绪谨慎\n**📊 业绩预期**: 业绩预期良好，上半年净利润4.74亿元，同比增长44.02%\n\n**🚨 风险警报**:\n- 风险点1：存在违规记录和信息披露问题\n- 风险点2：公司涉及诉讼仲裁事项\n- 风险点3：债务高企问题\n\n**✨ 利好催化**:\n- 利好1：上半年净利润同比增长44.02%\n- 利好2：华安证券给予买入评级\n- 利好3：新能源汽车热管理产业有发展前景\n\n**📢 最新动态**: 【最新消息】上半年净利润同比预增35%-50%，但存在违规记录和诉讼仲裁\n\n### 📌 核心结论\n\n**🟠 减仓** | 看空\n\n> **一句话决策**: 空头排列，建议卖出观望\n\n⏰ **时效性**: 立即行动\n\n| 持仓情况 | 操作建议 |\n|---------|---------|\n| 🆕 **空仓者** | 空仓者建议：继续观望，等待多头排列形成 |\n| 💼 **持仓者** | 持仓者建议：及时止损，控制风险 |\n\n### 📊 数据透视\n\n**均线排列**: 空头排列：MA5 < MA10 < MA20 | 多头排列: ❌ 否 | 趋势强度: 25/100\n\n| 价格指标 | 数值 |\n|---------|------|\n| 当前价 | 12.27 |\n| MA5 | 12.4 |\n| MA10 | 12.74 |\n| MA20 | 12.94 |\n| 乖离率(MA5) | -1.05% ✅安全 |\n| 支撑位 | 12.0 |\n| 压力位 | 12.94 |\n\n**量能**: 量比 1.11 (缩量) | 换手率 0.61%\n💡 *下跌趋势中缩量，抛压减轻但参与度低*\n\n**筹码**: 获利比例 4.1 | 平均成本 13.07 | 集中度 8.06 🚨警惕\n\n### 🎯 作战计划\n\n**📍 狙击点位**\n\n| 点位类型 | 价格 |\n|---------|------|\n| 🎯 理想买入点 | 暂无理想买入点（等待多头排列形成） |\n| 🔵 次优买入点 | 暂无次优买入点（等待多头排列形成） |\n| 🛑 止损位 | 止损位：12.00元（心理关口） |\n| 🎊 目标位 | 无目标位（建议止损观望） |\n\n**💰 仓位建议**: 建议仓位：0成（空仓观望）\n- 建仓策略: 暂不建仓，等待多头排列形成和风险因素消除\n- 风控策略: 严格止损，控制单只股票仓位不超过总资金的5%\n\n**✅ 检查清单**\n\n- ❌ 检查项1：多头排列\n- ✅ 检查项2：乖离率<5%\n- ⚠️ 检查项3：量能配合\n- ❌ 检查项4：无重大利空\n- ❌ 检查项5：筹码健康\n\n---\n\n## ⚪ 京投发展 (600683)\n\n### 📰 重要信息速览\n\n**💭 舆情情绪**: 市场情绪谨慎，技术面超买但基本面利空\n**📊 业绩预期**: 业绩预期：2025年预计大幅亏损12.3亿至10.25亿元，基本面恶化\n\n**🚨 风险警报**:\n- 风险点1：股东程少良减持预案\n- 风险点2：2023年有违规记录，涉及信息披露问题\n- 风险点3：2025年业绩预亏12.3亿至10.25亿元\n\n**✨ 利好催化**:\n- 利好1：均线多头排列\n- 利好2：国家对基础设施建设的持续投入\n\n**📢 最新动态**: 【最新消息】公司生产经营正常无重大未披露事项，但股东程少良存在减持计划\n\n### 📌 核心结论\n\n**⚪ 观望** | 看空\n\n> **一句话决策**: 乖离率过高，严禁追高，建议观望\n\n⏰ **时效性**: 立即行动\n\n| 持仓情况 | 操作建议 |\n|---------|---------|\n| 🆕 **空仓者** | 空仓者建议：乖离率过高，严禁追高，等待回踩均线 |\n| 💼 **持仓者** | 持仓者建议：考虑减仓或止盈，规避风险 |\n\n### 📊 数据透视\n\n**均线排列**: 多头排列：MA5>MA10>MA20 | 多头排列: ✅ 是 | 趋势强度: 70/100\n\n| 价格指标 | 数值 |\n|---------|------|\n| 当前价 | 6.6 |\n| MA5 | 5.58 |\n| MA10 | 5.08 |\n| MA20 | 4.73 |\n| 乖离率(MA5) | 18.28% 🚨危险 |\n| 支撑位 | 5.08 |\n| 压力位 | 6.6 |\n\n**量能**: 量比 5.66 (放量) | 换手率 9.0%\n💡 *巨量上涨，但需警惕是否是短期炒作*\n\n**筹码**: 获利比例 100.0 | 平均成本 4.71 | 集中度 19.38 🚨警惕\n\n### 🎯 作战计划\n\n**📍 狙击点位**\n\n| 点位类型 | 价格 |\n|---------|------|\n| 🎯 理想买入点 | 不适用（乖离率过高，严禁追高） |\n| 🔵 次优买入点 | 不适用（乖离率过高，严禁追高） |\n| 🛑 止损位 | 止损位：4.73元（跌破MA20） |\n| 🎊 目标位 | 目标位：不适用（当前不建议买入） |\n\n**💰 仓位建议**: 建议仓位：0成\n- 建仓策略: 暂不建仓，等待回踩MA10或MA20\n- 风控策略: 乖离率超过5%严禁追高，注意规避减持风险\n\n**✅ 检查清单**\n\n- ✅ 检查项1：多头排列\n- ❌ 检查项2：乖离率<5%\n- ⚠️ 检查项3：量能配合\n- ❌ 检查项4：无重大利空\n- ❌ 检查项5：筹码健康\n\n---\n\n## 🔴 精研科技 (300709)\n\n### 📰 重要信息速览\n\n**💭 舆情情绪**: 市场情绪悲观，投资者信心受挫\n**📊 业绩预期**: 2025年度业绩预告显示净利润为正值但同向下降，业绩承压\n\n**🚨 风险警报**:\n- 风险点1：股东创研投资违规减持公司股票\n- 风险点2：客户砍单导致业绩下滑\n- 风险点3：2025年度业绩预告净利润同向下降\n\n**✨ 利好催化**:\n- 利好1：90%筹码集中度10.99%，筹码较集中\n- 利好2：乖离率-2.66%，技术面短期超跌\n\n**📢 最新动态**: 【最新消息】董事长因客户砍单事件致歉，公司股价放量暴跌近15%\n\n### 📌 核心结论\n\n**🔴 卖出** | 看空\n\n> **一句话决策**: 空头排列且筹码结构差，建议卖出\n\n⏰ **时效性**: 立即行动\n\n| 持仓情况 | 操作建议 |\n|---------|---------|\n| 🆕 **空仓者** | 空仓者建议：暂不介入，等待多头排列形成 |\n| 💼 **持仓者** | 持仓者建议：立即卖出，规避进一步下跌风险 |\n\n### 📊 数据透视\n\n**均线排列**: 空头排列：MA5(39.84) < MA10(43.76) < MA20(46.1) | 多头排列: ❌ 否 | 趋势强度: 20/100\n\n| 价格指标 | 数值 |\n|---------|------|\n| 当前价 | 38.78 |\n| MA5 | 39.84 |\n| MA10 | 43.76 |\n| MA20 | 46.1 |\n| 乖离率(MA5) | -2.66% ✅安全 |\n| 支撑位 | 36.5 |\n| 压力位 | 40.0 |\n\n**量能**: 量比 0.77 (缩量) | 换手率 1.85%\n💡 *缩量下跌，抛压减轻但无买盘承接*\n\n**筹码**: 获利比例 0.0 | 平均成本 47.2 | 集中度 10.99 🚨警惕\n\n### 🎯 作战计划\n\n**📍 狙击点位**\n\n| 点位类型 | 价格 |\n|---------|------|\n| 🎯 理想买入点 | 理想买入点：暂不买入（等待多头排列形成） |\n| 🔵 次优买入点 | 次优买入点：暂不买入（等待多头排列形成） |\n| 🛑 止损位 | 止损位：36.5元（前期低点） |\n| 🎊 目标位 | 目标位：无（不建议持有） |\n\n**💰 仓位建议**: 建议仓位：0成\n- 建仓策略: 暂不建仓，等待趋势反转\n- 风控策略: 严格控制仓位，避免抄底\n\n**✅ 检查清单**\n\n- ❌ 检查项1：多头排列\n- ✅ 检查项2：乖离率<5%\n- ⚠️ 检查项3：量能配合\n- ❌ 检查项4：无重大利空\n- ❌ 检查项5：筹码健康\n\n---\n\n## 🔴 向日葵 (300111)\n\n### 📰 重要信息速览\n\n**💭 舆情情绪**: 市场情绪悲观，监管调查引发投资者担忧\n**📊 业绩预期**: 业绩预期不佳，2025年度业绩预告显示存在较大不确定性\n\n**🚨 风险警报**:\n- 风险点1：重组预案涉嫌误导性陈述被立案调查\n- 风险点2：历史业绩大幅亏损，2018年净亏损11.33亿元\n- 风险点3：筹码分散，多数投资者处于套牢状态\n\n**✨ 利好催化**:\n- 利好1：乖离率处于安全范围，无追高风险\n- 利好2：属于新能源太阳能电池行业，行业前景广阔\n\n**📢 最新动态**: 【最新消息】浙江证监局对向日葵重组预案涉嫌误导性陈述立案调查\n\n### 📌 核心结论\n\n**🔴 卖出** | 看空\n\n> **一句话决策**: 空头排列且遭立案调查，建议卖出观望\n\n⏰ **时效性**: 立即行动\n\n| 持仓情况 | 操作建议 |\n|---------|---------|\n| 🆕 **空仓者** | 空仓者建议：暂时观望，等待立案调查结果明朗 |\n| 💼 **持仓者** | 持仓者建议：立即卖出，规避监管风险 |\n\n### 📊 数据透视\n\n**均线排列**: 空头排列：MA5 < MA10 < MA20 | 多头排列: ❌ 否 | 趋势强度: 20/100\n\n| 价格指标 | 数值 |\n|---------|------|\n| 当前价 | 4.65 |\n| MA5 | 4.55 |\n| MA10 | 4.62 |\n| MA20 | 5.06 |\n| 乖离率(MA5) | 2.2% ⚠️警戒 |\n| 支撑位 | 4.5 |\n| 压力位 | 4.8 |\n\n**量能**: 量比 1.35 (温和放量) | 换手率 1.47%\n💡 *温和放量但不足以改变趋势，抛压仍存*\n\n**筹码**: 获利比例 35.4 | 平均成本 4.73 | 集中度 27.27 🚨警惕\n\n### 🎯 作战计划\n\n**📍 狙击点位**\n\n| 点位类型 | 价格 |\n|---------|------|\n| 🎯 理想买入点 | 理想买入点：暂不建议买入，等待调查结果 |\n| 🔵 次优买入点 | 次优买入点：暂不建议买入 |\n| 🛑 止损位 | 止损位：4.50元（跌破近期低点） |\n| 🎊 目标位 | 目标位：不适用（建议卖出） |\n\n**💰 仓位建议**: 建议仓位：0成（清仓）\n- 建仓策略: 暂无入场计划，等待监管风险解除\n- 风控策略: 严格止损，避免持有存在监管风险的股票\n\n**✅ 检查清单**\n\n- ❌ 检查项1：多头排列\n- ✅ 检查项2：乖离率<5%\n- ⚠️ 检查项3：量能配合\n- ❌ 检查项4：无重大利空\n- ❌ 检查项5：筹码健康\n\n---\n\n## ⚪ 博威合金 (601137)\n\n### 📰 重要信息速览\n\n**💭 舆情情绪**: 市场对业绩大幅预减反应悲观\n**📊 业绩预期**: 2025年业绩预期大幅下滑，需警惕持续性\n\n**🚨 风险警报**:\n- 风险点1：2025年业绩预降88.92%-92.61%\n- 风险点2：历史违规记录\n- 风险点3：控股股东减持行为\n\n**✨ 利好催化**:\n- 利好1：西部证券首次覆盖给予买入评级\n- 利好2：铜基合金领域技术壁垒深厚\n- 利好3：自主研发AI材料研发大模型\n\n**📢 最新动态**: 【最新消息】2025年净利润同比预减88.92%-92.61%\n\n### 📌 核心结论\n\n**⚪ 观望** | 看空\n\n> **一句话决策**: 空头排列，业绩大幅预减，建议观望\n\n⏰ **时效性**: 不急\n\n| 持仓情况 | 操作建议 |\n|---------|---------|\n| 🆕 **空仓者** | 空仓者建议：暂时观望，等待多头排列形成 |\n| 💼 **持仓者** | 持仓者建议：考虑减仓或止损，规避业绩下滑风险 |\n\n### 📊 数据透视\n\n**均线排列**: 空头排列，MA5 < MA10 < MA20 | 多头排列: ❌ 否 | 趋势强度: 20/100\n\n| 价格指标 | 数值 |\n|---------|------|\n| 当前价 | 18.8 |\n| MA5 | 19.1 |\n| MA10 | 20.18 |\n| MA20 | 21.52 |\n| 乖离率(MA5) | -1.57% ✅安全 |\n| 支撑位 | 18.0 |\n| 压力位 | 19.1 |\n\n**量能**: 量比 1.26 (温和放量) | 换手率 1.09%\n💡 *温和放量但成交不足，市场参与度不高*\n\n**筹码**: 获利比例 1.7 | 平均成本 21.96 | 集中度 15.05 🚨警惕\n\n### 🎯 作战计划\n\n**📍 狙击点位**\n\n| 点位类型 | 价格 |\n|---------|------|\n| 🎯 理想买入点 | 理想买入点：暂不考虑，等待多头排列 |\n| 🔵 次优买入点 | 次优买入点：暂不考虑 |\n| 🛑 止损位 | 止损位：18.0元（跌破近期低点） |\n| 🎊 目标位 | 目标位：暂无 |\n\n**💰 仓位建议**: 建议仓位：0-1成\n- 建仓策略: 暂不考虑建仓，等待技术面改善\n- 风控策略: 严格止损，控制仓位\n\n**✅ 检查清单**\n\n- ❌ 检查项1：多头排列\n- ✅ 检查项2：乖离率<5%\n- ⚠️ 检查项3：量能配合\n- ❌ 检查项4：无重大利空\n- ❌ 检查项5：筹码健康\n\n---\n\n## 🔴 华夏幸福 (600340)\n\n### 📰 重要信息速览\n\n**💭 舆情情绪**: 市场对重整方案存在分歧，投资者情绪谨慎\n**📊 业绩预期**: 2025年预计巨亏160亿至240亿元，基本面极差，市盈率-0.52，市净率-1.35\n\n**🚨 风险警报**:\n- 风险点1：2025年净利预亏160亿至240亿元\n- 风险点2：债务危机，16.52亿元信托受益权份额未被领受\n- 风险点3：内部矛盾，平安系董事质疑重整方案\n\n**✨ 利好催化**:\n- 利好1：被纳入首批"白名单"房企，或获得政策支持\n- 利好2：政府工作报告强调"保交楼"和房企融资支持\n\n**📢 最新动态**: 【最新消息】华夏幸福预重整进展引发关注，股价曾收三个涨停板\n\n### 📌 核心结论\n\n**🔴 卖出** | 看空\n\n> **一句话决策**: 空头趋势中，建议减仓或观望\n\n⏰ **时效性**: 立即行动\n\n| 持仓情况 | 操作建议 |\n|---------|---------|\n| 🆕 **空仓者** | 空仓者建议：暂时观望，等待重整进展明朗 |\n| 💼 **持仓者** | 持仓者建议：减仓或止损，控制风险 |\n\n### 📊 数据透视\n\n**均线排列**: MA5 < MA10 < MA20，空头排列 | 多头排列: ❌ 否 | 趋势强度: 25/100\n\n| 价格指标 | 数值 |\n|---------|------|\n| 当前价 | 1.64 |\n| MA5 | 1.61 |\n| MA10 | 1.66 |\n| MA20 | 1.75 |\n| 乖离率(MA5) | 1.86% ✅安全 |\n| 支撑位 | 1.6 |\n| 压力位 | 1.7 |\n\n**量能**: 量比 1.26 (缩量) | 换手率 2.53%\n💡 *缩量下跌，抛压减轻但买盘不足*\n\n**筹码**: 获利比例 34.0 | 平均成本 1.69 | 集中度 24.31 🚨警惕\n\n### 🎯 作战计划\n\n**📍 狙击点位**\n\n| 点位类型 | 价格 |\n|---------|------|\n| 🎯 理想买入点 | 不推荐买入，观望为主 |\n| 🔵 次优买入点 | 暂不考虑 |\n| 🛑 止损位 | 1.55元（跌破前期低点） |\n| 🎊 目标位 | 1.80元（如重整成功可能反弹至此） |\n\n**💰 仓位建议**: 建议仓位：0-1成（极轻仓或空仓）\n- 建仓策略: 不推荐入场，等待重整方案明朗\n- 风控策略: 如需持有，严格设置止损，控制单只股票仓位\n\n**✅ 检查清单**\n\n- ❌ 检查项1：多头排列\n- ✅ 检查项2：乖离率<5%\n- ⚠️ 检查项3：量能配合\n- ❌ 检查项4：无重大利空\n- ❌ 检查项5：筹码健康\n\n---\n\n## 🔴 中马传动 (603767)\n\n### 📰 重要信息速览\n\n**💭 舆情情绪**: 市场对业绩预亏反应悲观，情绪偏空\n**📊 业绩预期**: 业绩预期不佳，预计2025年亏损540万元-800万元\n\n**🚨 风险警报**:\n- 风险点1：2025年上半年业绩预降65.63%-75.82%\n- 风险点2：预计2025年亏损\n- 风险点3：历史违规记录\n\n**✨ 利好催化**:\n- 公司拥有技术和人才优势\n\n**📢 最新动态**: 【最新消息】中马传动：预计2025年亏损540万元-800万元\n\n### 📌 核心结论\n\n**🔴 卖出** | 看空\n\n> **一句话决策**: 空头排列且业绩预亏，建议减仓或卖出\n\n⏰ **时效性**: 立即行动\n\n| 持仓情况 | 操作建议 |\n|---------|---------|\n| 🆕 **空仓者** | 空仓者建议：暂不介入，等待多头排列形成 |\n| 💼 **持仓者** | 持仓者建议：减仓或卖出，规避业绩风险 |\n\n### 📊 数据透视\n\n**均线排列**: 空头排列：MA5 < MA10 < MA20 | 多头排列: ❌ 否 | 趋势强度: 20/100\n\n| 价格指标 | 数值 |\n|---------|------|\n| 当前价 | 21.45 |\n| MA5 | 21.36 |\n| MA10 | 21.78 |\n| MA20 | 22.9 |\n| 乖离率(MA5) | 0.42% ✅安全 |\n| 支撑位 | 20.5 |\n| 压力位 | 22.9 |\n\n**量能**: 量比 0.91 (缩量) | 换手率 0.42%\n💡 *缩量调整，但空头趋势下交投不活跃*\n\n**筹码**: 获利比例 5.4 | 平均成本 23.93 | 集中度 16.35 🚨警惕\n\n### 🎯 作战计划\n\n**📍 狙击点位**\n\n| 点位类型 | 价格 |\n|---------|------|\n| 🎯 理想买入点 | 理想买入点：不适用（不建议买入） |\n| 🔵 次优买入点 | 次优买入点：不适用（不建议买入） |\n| 🛑 止损位 | 止损位：20.50元（跌破前低） |\n| 🎊 目标位 | 目标位：不适用（建议减仓） |\n\n**💰 仓位建议**: 建议仓位：0-1成\n- 建仓策略: 暂不建议建仓，等待多头排列形成\n- 风控策略: 严格控制仓位，规避业绩风险\n\n**✅ 检查清单**\n\n- ❌ 检查项1：多头排列\n- ✅ 检查项2：乖离率<5%\n- ⚠️ 检查项3：量能配合\n- ❌ 检查项4：无重大利空\n- ❌ 检查项5：筹码健康\n\n---\n\n\n*报告生成时间：2026-02-05 11:01:38*'
        # upload_recommendation_analysis(full_content)
        # return
        # 命令行参数 --single-notify 覆盖配置（#55）
        if getattr(args, 'single_notify', False):
            config.single_stock_notify = True
        
        # 创建调度器
        save_context_snapshot = None
        if getattr(args, 'no_context_snapshot', False):
            save_context_snapshot = False
        query_id = uuid.uuid4().hex
        pipeline = StockAnalysisPipeline(
            config=config,
            max_workers=args.workers,
            query_id=query_id,
            query_source="cli",
            save_context_snapshot=save_context_snapshot
        )
        
        # 1. 运行个股分析
        results = pipeline.run(
            stock_codes=stock_codes,
            dry_run=args.dry_run,
            send_notification=not args.no_notify
        )

        # Issue #128: 分析间隔 - 在个股分析和大盘分析之间添加延迟
        analysis_delay = getattr(config, 'analysis_delay', 0)
        if analysis_delay > 0 and config.market_review_enabled and not args.no_market_review:
            logger.info(f"等待 {analysis_delay} 秒后执行大盘复盘（避免API限流）...")
            time.sleep(analysis_delay)

        # 2. 运行大盘复盘（如果启用且不是仅个股模式）
        market_report = ""
        if config.market_review_enabled and not args.no_market_review:
            # 只调用一次，并获取结果
            review_result = run_market_review(
                notifier=pipeline.notifier,
                analyzer=pipeline.analyzer,
                search_service=pipeline.search_service,
                send_notification=not args.no_notify
            )
            # 如果有结果，赋值给 market_report 用于后续飞书文档生成
            if review_result:
                market_report = review_result
        
        # 输出摘要
        if results:
            logger.info("\n===== 分析结果摘要 =====")
            for r in sorted(results, key=lambda x: x.sentiment_score, reverse=True):
                emoji = r.get_emoji()
                logger.info(
                    f"{emoji} {r.name}({r.code}): {r.operation_advice} | "
                    f"评分 {r.sentiment_score} | {r.trend_prediction}"
                )
        
        logger.info("\n任务执行完成")

        # 1. 准备标题 "01-01 13:01大盘复盘"
        tz_cn = timezone(timedelta(hours=8))
        now = datetime.now(tz_cn)
        doc_title = f"{now.strftime('%Y-%m-%d %H:%M')} 大盘复盘"

        # 2. 准备内容 (拼接个股分析和大盘复盘)
        full_content = ""

        # 添加大盘复盘内容（如果有）
        if market_report:
            full_content += f"# 📈 大盘复盘\n\n{market_report}\n\n---\n\n"

        # 添加个股决策仪表盘（使用 NotificationService 生成）
        if results:
            dashboard_content = pipeline.notifier.generate_dashboard_report(results)
            full_content += f"# 🚀 个股决策仪表盘\n\n{dashboard_content}"

        # print(full_content)

        upload_recommendation_analysis(full_content)

        
    except Exception as e:
        logger.exception(f"分析流程执行失败: {e}")


def start_bot_stream_clients(config: Config) -> None:
    """Start bot stream clients when enabled in config."""
    # 启动钉钉 Stream 客户端
    if config.dingtalk_stream_enabled:
        try:
            from bot.platforms import start_dingtalk_stream_background, DINGTALK_STREAM_AVAILABLE
            if DINGTALK_STREAM_AVAILABLE:
                if start_dingtalk_stream_background():
                    logger.info("[Main] Dingtalk Stream client started in background.")
                else:
                    logger.warning("[Main] Dingtalk Stream client failed to start.")
            else:
                logger.warning("[Main] Dingtalk Stream enabled but SDK is missing.")
                logger.warning("[Main] Run: pip install dingtalk-stream")
        except Exception as exc:
            logger.error(f"[Main] Failed to start Dingtalk Stream client: {exc}")

    # 启动飞书 Stream 客户端
    if getattr(config, 'feishu_stream_enabled', False):
        try:
            from bot.platforms import start_feishu_stream_background, FEISHU_SDK_AVAILABLE
            if FEISHU_SDK_AVAILABLE:
                if start_feishu_stream_background():
                    logger.info("[Main] Feishu Stream client started in background.")
                else:
                    logger.warning("[Main] Feishu Stream client failed to start.")
            else:
                logger.warning("[Main] Feishu Stream enabled but SDK is missing.")
                logger.warning("[Main] Run: pip install lark-oapi")
        except Exception as exc:
            logger.error(f"[Main] Failed to start Feishu Stream client: {exc}")

def get_recommendations():
    recommendations = []
    url = 'https://stock.ai.hamuna.club/stocks/recommendations/latest'
    with httpx.Client() as client:
        response = client.post(url, json={})
        response.raise_for_status()
        response = response.json()
        if response['success'] == 'ok':
            recommendations = response['data']['recommendations']
        
    return recommendations

def upload_recommendation_analysis(content):
    logger.info('uploading recommendation analysis...')
    url = 'https://stock.ai.hamuna.club/recommendations/analysis'
    date = datetime.now()
    with httpx.Client() as client:
        for i in range(3):
            try:
                response = client.post(url, json={
                    'date': date.date().strftime('%Y-%m-%d'),
                    'time': date.time().strftime('%H:%M'),
                    'summary': content[:20] + '...',
                    'content': content
                })
                response.raise_for_status()
                response = response.json()
                if response['success'] == 'ok':
                    logger.info(f"推荐分析上传成功")
                    break
                else:
                    logger.error(f"推荐分析上传失败: {response['msg']}")
                    time.sleep(5)
            except Exception as e:
                logger.error(f"推荐分析上传失败: {e}")
                time.sleep(5)

def main() -> int:
    """
    主入口函数
    
    Returns:
        退出码（0 表示成功）
    """
    # 解析命令行参数
    args = parse_arguments()
    
    # 加载配置（在设置日志前加载，以获取日志目录）
    config = get_config()
    
    # 配置日志（输出到控制台和文件）
    setup_logging(debug=args.debug, log_dir=config.log_dir)
    
    logger.info("=" * 60)
    logger.info("A股自选股智能分析系统 启动")
    logger.info(f"运行时间: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}")
    logger.info("=" * 60)
    
    # 验证配置
    warnings = config.validate()
    for warning in warnings:
        logger.warning(warning)
    
    # 解析股票列表
    # stock_codes = None
    # if args.stocks:
    #     stock_codes = [code.strip() for code in args.stocks.split(',') if code.strip()]
    #     logger.info(f"使用命令行指定的股票列表: {stock_codes}")
    for _ in range(3):
        try:
            recommendations = get_recommendations()
            if recommendations:
                logger.info(f"获取到 {len(recommendations)} 条推荐")
                break
        except Exception as e:
            logger.error(f"获取推荐失败: {e}")
            time.sleep(5)

    stock_codes = [item['股票代码'] for item in recommendations][:20]
    
    # === 启动 WebUI (如果启用) ===
    # 优先级: 命令行参数 > 配置文件
    start_webui = (args.webui or args.webui_only or config.webui_enabled) and os.getenv("GITHUB_ACTIONS") != "true"
    
    if start_webui:
        try:
            from webui import run_server_in_thread
            run_server_in_thread(host=config.webui_host, port=config.webui_port)
            start_bot_stream_clients(config)
        except Exception as e:
            logger.error(f"启动 WebUI 失败: {e}")
    
    # === 仅 WebUI 模式：不自动执行分析 ===
    if args.webui_only:
        logger.info("模式: 仅 WebUI 服务")
        logger.info(f"WebUI 运行中: http://{config.webui_host}:{config.webui_port}")
        logger.info("通过 /analysis?code=xxx 接口手动触发分析")
        logger.info("按 Ctrl+C 退出...")
        try:
            while True:
                time.sleep(1)
        except KeyboardInterrupt:
            logger.info("\n用户中断，程序退出")
        return 0

    try:
        # 模式1: 仅大盘复盘
        if args.market_review:
            logger.info("模式: 仅大盘复盘")
            notifier = NotificationService()
            
            # 初始化搜索服务和分析器（如果有配置）
            search_service = None
            analyzer = None
            
            if config.bocha_api_keys or config.tavily_api_keys or config.serpapi_keys:
                search_service = SearchService(
                    bocha_keys=config.bocha_api_keys,
                    tavily_keys=config.tavily_api_keys,
                    serpapi_keys=config.serpapi_keys
                )
            
            if config.gemini_api_key or config.openai_api_key:
                analyzer = GeminiAnalyzer(api_key=config.gemini_api_key)
                if not analyzer.is_available():
                    logger.warning("AI 分析器初始化后不可用，请检查 API Key 配置")
                    analyzer = None
            else:
                logger.warning("未检测到 API Key (Gemini/OpenAI)，将仅使用模板生成报告")
            
            run_market_review(
                notifier=notifier, 
                analyzer=analyzer, 
                search_service=search_service,
                send_notification=not args.no_notify
            )
            return 0
        
        # 模式2: 定时任务模式
        if args.schedule or config.schedule_enabled:
            logger.info("模式: 定时任务")
            logger.info(f"每日执行时间: {config.schedule_time}")
            
            from src.scheduler import run_with_schedule
            
            def scheduled_task():
                run_full_analysis(config, args, stock_codes)
            
            run_with_schedule(
                task=scheduled_task,
                schedule_time=config.schedule_time,
                run_immediately=True  # 启动时先执行一次
            )
            return 0
        
        # 模式3: 正常单次运行
        run_full_analysis(config, args, stock_codes)
        
        logger.info("\n程序执行完成")
        
        # 如果启用了 WebUI 且是非定时任务模式，保持程序运行以便访问 WebUI
        if start_webui and not (args.schedule or config.schedule_enabled):
            logger.info("WebUI 运行中 (按 Ctrl+C 退出)...")
            try:
                # 简单的保持活跃循环
                while True:
                    time.sleep(1)
            except KeyboardInterrupt:
                pass
        
        return 0
        
    except KeyboardInterrupt:
        logger.info("\n用户中断，程序退出")
        return 130
        
    except Exception as e:
        logger.exception(f"程序执行失败: {e}")
        return 1


if __name__ == "__main__":
    sys.exit(main())
